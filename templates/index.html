<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
        <title>Test</title>
        <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@latest"></script>
        <style>
                div.container {
                        width: 80%;
                }
        </style>
</head>
<body>
        <br>
        <div class="container">
                <div class="row">
                        <div class="col-6">
                                <h2>上傳xlsx至資料庫 : </h2><input type="file" id="file-input2"/>
                        </div>
                        <div class="col-6">
                                <h2>送出修改資料至資料庫 : </h2><button id="update_database">送出</button>
                        </div>
                </div>
                <br>
                <div class="row">
                        <h2>匯出客戶資料 : </h2><input type="file" id="file-input"/>
                </div>
                <br>
                <div class="row">
                        <div class="col" id="table_space">
                                
                        </div>
                </div>
        </div>
</body>
<script>
        var newtable;
        document.getElementById('file-input').addEventListener('change', readSingleFile);
        document.getElementById('file-input2').addEventListener('change', readSingleFile2);
        document.getElementById('update_database').addEventListener('click', update_database);
        
        async function update_database(){
                var data = newtable.rows().data();
                var dataArray = data.toArray();
                var jsonData = JSON.stringify(dataArray);
                //console.log(jsonData);
                //console.log(dataArray);
                const options = {
                                method: "POST",
                                headers: {
                                        "Content-Type": "application/json",
                                },
                                body: JSON.stringify(dataArray),
                        };

                const response = await fetch("/update_database", options);
                const json = await response.json();
        }

        load_database();
        async function load_database(){
                var table = document.getElementById("excel");
                if( table == undefined ){

                        const options = {
                                method: "POST",
                                headers: {
                                        "Content-Type": "application/json",
                                },
                                body: JSON.stringify({}),
                        };

                        const response = await fetch("/load_database", options);
                        const json = await response.json();
                        temp_json = JSON.parse(json["result"]);
                        //console.log(temp_json);

                        var cc = document.getElementById("table_space");
                        var table = document.createElement("table");
                        table.id = "excel";
                        cc.appendChild(table);
                        newtable = $('#excel').DataTable({
                                        "data": temp_json,
                                        "columns": [
                                                { data: 'id', title: "id"},
                                                { data: 'name', title: "name"},
                                                { data: 'identity', title: "identity"},
                                                { data: 'address', title: "address"},
                                                { data: 'phone', title: "phone"},
                                                { data: 'remark', title: "remark"},
                                                { data: 'number', title: "number"},
                                                {
                                                        title: 'Delete',
                                                        data: null,
                                                        defaultContent: '<button class="btn btn-danger btn-sm">Delete</button>'
                                                }
                                        ],
                                        //"searching": false,
                                        "ordering": false,
                                        "select": true
                        })
                        $('#excel tbody').on('click', 'button.btn-danger', function() {
                                var row = newtable.row($(this).parents('tr'));
                                row.remove().draw(false);
                        });
                        newtable.on('click', 'tbody td', async function() {
                                var cell = newtable.cell(this);
                                var cellData = cell.data();
                                var colIdx = cell.index().column; // 取得該單元格的直欄索引
                                var colName = newtable.settings().init().columns[colIdx].title; // 取得直欄名稱
                                //console.log("Clicked column name:", colName);
                                //console.log("Cell value:", cellData);
                                if( cellData == "" || cellData == null ){
                                        cellData = "";
                                }
                                const { value: ipAddress } = await Swal.fire({
                                        title: "請輸入要修改的內容",
                                        input: "text",
                                        inputLabel: colName,
                                        inputValue: cellData,
                                        showCancelButton: true,
                                        inputValidator: (value) => {
                                                if (!value) {
                                                        return "You need to write something!";
                                                }
                                        }
                                });
                                if (ipAddress) {
                                        cell.data(`${ipAddress}`);
                                }
                        });
                }
        }
        
        async function readSingleFile(e) {
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            
            let formData = new FormData();
            formData.append('clientFile', file);
            formData.append('kind', "result");
            
            const options = {
                method: "POST",
                headers: {
                    //"Content-Type": "application/json",
                    //"Content-Type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                },
                //body: JSON.stringify(data),
                //body: file,
                body: formData,
            };
    
            await fetch("/merge_submit", options)
                .then(response => response.json())
                .then(json => {
                        temp_json = JSON.parse(json["result"]);
                        //console.log(temp_json);
                        // Convert JSON to Excel workbook
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.json_to_sheet(temp_json);

                        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                        // Save workbook to Excel file
                        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                        const blob = new Blob([wbout], { type: 'application/octet-stream' });

                        // Trigger file download
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'output.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                })
                .catch(error => console.error('Error:', error));
        }
        
        async function readSingleFile2(e) {
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            
            let formData = new FormData();
            formData.append('clientFile', file);
            formData.append('kind', "result");
            
            const options = {
                method: "POST",
                headers: {
                    //"Content-Type": "application/json",
                    //"Content-Type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                },
                //body: JSON.stringify(data),
                //body: file,
                body: formData,
            };
    
            await fetch("/database_submit", options)
                .then(response => response.json())
                .then(json => {
                        
                })
                .catch(error => console.error('Error:', error));
        }
</script>
</html>