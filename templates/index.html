<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
        <title>Test</title>
        <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
        <style>
                div.container {
                        width: 80%;
                }
        </style>
</head>
<body>
        <br>
        <div class="container">
                <div class="row">
                        <h2>更新資料庫 : </h2><input type="file" id="file-input2"/>
                </div>
                <br>
                <div class="row">
                        <h2>匯入檔案抓取客戶資料 : </h2><input type="file" id="file-input"/>
                </div>
        </div>
</body>
<script>
        document.getElementById('file-input').addEventListener('change', readSingleFile);
        document.getElementById('file-input2').addEventListener('change', readSingleFile2);
        async function readSingleFile(e) {
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            
            let formData = new FormData();
            formData.append('clientFile', file);
            formData.append('kind', "result");
            
            const options = {
                method: "POST",
                headers: {
                    //"Content-Type": "application/json",
                    //"Content-Type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                },
                //body: JSON.stringify(data),
                //body: file,
                body: formData,
            };
    
            await fetch("/merge_submit", options)
                .then(response => response.json())
                .then(json => {
                        temp_json = JSON.parse(json["result"]);
                        //console.log(temp_json);
                        // Convert JSON to Excel workbook
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.json_to_sheet(temp_json);

                        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                        // Save workbook to Excel file
                        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                        const blob = new Blob([wbout], { type: 'application/octet-stream' });

                        // Trigger file download
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'output.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                })
                .catch(error => console.error('Error:', error));
        }
        
        async function readSingleFile2(e) {
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            
            let formData = new FormData();
            formData.append('clientFile', file);
            formData.append('kind', "result");
            
            const options = {
                method: "POST",
                headers: {
                    //"Content-Type": "application/json",
                    //"Content-Type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                },
                //body: JSON.stringify(data),
                //body: file,
                body: formData,
            };
    
            await fetch("/database_submit", options)
                .then(response => response.json())
                .then(json => {
                        
                })
                .catch(error => console.error('Error:', error));
        }
</script>
</html>